name: Debug Boot Test with Bochs

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build-and-boot:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      IMAGE: emergeos.img
      SERIAL: serial.log
      BOCHS_LOG: bochs.log
      BOCHS_CONFIG: bochsrc.txt

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y build-essential nasm gcc-multilib bochs bochs-x gettext-base

      - name: Build kernel image
        run: |
          make clean || true
          make "$IMAGE"
          ls -lh "$IMAGE"

      - name: Create Bochs configuration
        run: |
          cat > "$BOCHS_CONFIG" <<'EOF'
# ---------- minimal strict Bochs 2.7 rc ----------
megs: 64
floppya: 1_44=${IMAGE}, status=inserted
boot: a
log: ${BOCHS_LOG}
panic: action=fatal
error: action=fatal
cpu: model=pentium
com1: enabled=1, mode=file, dev=${SERIAL}
magic_break: enabled=1
display_library: x
# -------------------------------------------------
EOF
          envsubst < "$BOCHS_CONFIG" > tmp
          mv tmp "$BOCHS_CONFIG"
          cat "$BOCHS_CONFIG"

      - name: Run Bochs
        run: |
          set -o pipefail
          timeout 15s bochs -qf "$BOCHS_CONFIG" 2>&1 | tee bochs_stderr.log

      - name: Show serial output
        run: |
          echo '----- serial.log -----'
          cat "$SERIAL" || true

      - name: Show last 50 lines of Bochs log
        run: tail -50 "$BOCHS_LOG"
